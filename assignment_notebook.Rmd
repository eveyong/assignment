---
title: "Housing in London"
author: "Wen Qian Yong"
date: "May 2021"
header-includes: 
- \usepackage{fancyhdr}
- \pagestyle{fancy}
- \fancyhead[R]{Wen Qian Yong}
- \fancyfoot[C]{Housing in London}
- \fancyfoot[R]{\thepage}
subtitle: "What contributes to London's house prices?"
abstract: "The Kaggle dataset used here is primarily centered around the housing market of London. It contains a lot of additional relevant data, such as average house prices, salary, percentage of households that recycle, life satisfaction, number of jobs, area size in hectares, number of people living in the area, and the number of crimes committed. The dataset is used to analyse how London's house prices change over time and what contributes to different house prices in different boroughs, then ultimately predict future house prices using machine learning techniques."
keywords: "House prices, prediction, machine learning, data analytics"
output: 
  pdf_document:
    toc: true
    
---

```{r global-options, include=FALSE}
#install.packages("fancyhdr")
#library(fancyhdr)
#install.packages("knitr")

# setting global options for the code to not show in PDF, but these will be picked up in appendix via another code
library(knitr) 
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE)

```
\newpage

## Introduction

The dataset chosen is the "Housing in London 2020", found on Kaggle (https://www.kaggle.com/justinas/housing-in-london), split by areas of London called boroughs (a flag exists to identify these). This dataset contains a lot of additional relevant data, such as average house prices, salary, percentage of households that recycle, life satisfaction, number of jobs, area size in hectares, number of people living in the area, and the number of crimes committed.The data is split into two files based on the variable collection frequency (monthly and yearly).

The purpose of choosing this dataset is to analyse how London's house prices change over time and what contributes to different house prices in different boroughs. There are several machine learning algorithms used to predict London's house prices and results are compared to determine which alhorithm works better for this dataset.

The report includes:

* Data cleaning and preparation
* Data exploration and visualisation
* Modelling, prediction, and evaluation
* Conclusion
* R code in the appendices




## Data Cleaning and Preparation

There are two sets of data - monthly and yearly. We take a look at each one of them to find out what information is available and check for duplicates and missing values. Then we determine which variables or columns are least useful (so we drop them) or which ones require modifying for our analysis.


```{r}
#clearing out the environment first
rm(list=ls()) 

#importing the data from monthly file first
data_monthly_raw <- read.csv("1_data/housing_in_london_monthly_variables.csv", sep = ",", header = TRUE)
str(data_monthly_raw)

```
```{r}
#pushing this to a separate r line because it could not fit the frame with the structure above
head(data_monthly_raw)
```

The monthly data contains 13,549 rows and 7 columns. This data also contains the "average price" variable that we need to predict by the end of the report. It also contains the code and area, which could be useful for matching against the yearly data. There is also crime information, which might be useful to predict house prices. 

Checking for missing values.

```{r}
#install.packages("psych")
#library(psych)
#describe(data_monthly_raw)


#install.packages("naniar")
library(naniar)
miss_var_summary(data_monthly_raw)

```

From the table above, we can see that a very small percentage of "houses sold" is missing values. The field "no_of_crimes" appears to be 45% missing from the data, which seems to be a concern for the analysis. 

```{r}

#install.packages("ggplot2")
library(ggplot2)
library(dplyr)

#introduce the year and month columns rather than relying on the date column
data_monthly <- data_monthly_raw %>% 
  mutate(year = as.numeric(substr(date,1,4))) %>% 
  mutate(month = as.numeric(substr(date,6,7)))

#checking the crime column to see why so many are missing
data_monthly %>% 
  ggplot(aes(year, no_of_crimes, col = borough_flag)) +
  geom_point(show.legend = T) 
#looks like it is only introduced in 2001


```

Figure X above shows that the crime data was only introduced in 2001, and that it only exists for data within London's boroughs (those with the flag =1), which is the main focus of the data analysis. No further action on the crime column for now until we join the monthly data with the yearly data. 

The following data manipulations are performed to the monthly data:

* Introduce two additional columns called "year" and "month" to represent the year and month of the data because it will make joining to the yearly data file easier;
* Replace the missing values of "houses sold" with the mean value because so few are missing, it would not make a huge difference what it is replaced by, but getting rid of the missing values will be useful for data analysis further down the track; and
* Filter for boroughs in London only as that is the target market we are interested in only, this reduces the number of rows to 9,936.


```{r}
data_monthly <- data_monthly_raw %>% 
  filter(borough_flag == 1) %>%
  mutate(year = as.numeric(substr(date,1,4))) %>% #to preserve the previous manipulations
  mutate(month = as.numeric(substr(date,6,7))) %>% #to preserve the previous manipulations
  mutate(houses_sold = ifelse(is.na(houses_sold), mean(houses_sold,na.rm=TRUE), houses_sold))
  
#checking for missing values
miss_var_summary(data_monthly)
```

Next, we explore the yearly data.

```{r}
#importing the data from the yearly file
data_yearly_raw <- read.csv("1_data/housing_in_london_yearly_variables.csv", sep = ",", header = TRUE)
str(data_yearly_raw)
head(data_yearly_raw)

```

The yearly data is more generous, it contains more factors that could contribute to average house prices, e.g. life satisfaction, area size, population, salary, etc. As pointed out in the monthly data, we see that "code" and "area" are the common variables / columns among the two data files.


```{r}
#describe(data_yearly)
miss_var_summary(data_yearly_raw) 

```
Like the monthly data, there seems to be some missing variables in the yearly data, most of which can be manipulated to populate some data. The field "life satisfaction" is almost 70% missing from the data, so we might choose to drop that field altogether. Before we do that, we look at the distribution of life satisfaction, area size, number of houses, and number of jobs to see why there are so many missing values.


```{r}

#introduce the year column for easy plotting and only filter for London boroughs
data_yearly <- data_yearly_raw %>% 
  filter(borough_flag == 1) %>%
  mutate(year = as.numeric(substr(date,1,4)))

p1 <- data_yearly %>% 
        ggplot(aes(year, life_satisfaction)) +
        geom_point(color = "blue") +
        theme(plot.margin=unit(c(0.25,0.5,0.25,0.5),"cm"))

p2 <- data_yearly %>% 
        ggplot(aes(year, area_size)) +
        geom_point(color = "dark green") +
        theme(plot.margin=unit(c(0.25,0.5,0.25,0.5),"cm"))

p3 <- data_yearly %>% 
        ggplot(aes(year, no_of_houses)) +
        geom_point(color = "maroon") +
        theme(plot.margin=unit(c(0.25,0.5,0.25,0.5),"cm"))

p4 <- data_yearly %>% 
        ggplot(aes(year, number_of_jobs)) +
        geom_point(color = "orange") +
        theme(plot.margin=unit(c(0.25,0.5,0.25,0.5),"cm"))

p5 <- data_yearly %>% 
        ggplot(aes(year, population_size)) +
        geom_point(color = "mistyrose4") +
        theme(plot.margin=unit(c(0.25,0.5,0.25,0.5),"cm"))

p6 <- data_yearly %>% 
        ggplot(aes(year, median_salary)) +
        geom_point(color = "plum4") +
        theme(plot.margin=unit(c(0.5,0.5,0.5,0.5),"cm"))

#use gridExtra for arranging the graphs on one panel
#install.packages("gridExtra")
library(gridExtra)
#install.packages("grid")
library(grid)

grid.arrange(
  p1,
  p2,
  p3,
  p4,
  p5,
  p6,
  nrow = 3.5,
  top = "Why are there missing values from these variables?",
  bottom = textGrob(
    "filtered for areas in London boroughs",
    gp = gpar(fontface = 3, fontsize = 9),
    hjust = 1,
    x = 1
  )
)

```

The reason why life satisfaction has so many missing variables is because the data collection did not start until past 2010. While we may not use this in our machine learning techniques, we could still choose to separate the analysis into post-2010 with life satisfaction added as another factor.

For the other missing variables, we make the following observations:
* population size, number of jobs, and number of houses for 2019 is not populated
* area size is constant and only populated from 2001 to 2018
* median salary is populated since 1999


```{r, include = FALSE}
#don't need to include the output from here

#need the dplyr for data manipulation
#install.packages("dplyr")
library(dplyr)

data_yearly <- data_yearly_raw %>% 
  filter(borough_flag == 1) %>%
  mutate(year = as.numeric(substr(date,1,4))) %>% 
  mutate(month = as.numeric(substr(date,6,7)))  

#the following code populates area size for each borough according to its mean (constant number)
#also the same procedure for median salary
#install.packages("data.table")
library(data.table)
library(plyr); library(dplyr)
setDT(data_yearly)
data_yearly[, area_size := impute_mean(area_size), by = area][, median_salary := impute_mean(median_salary), by = area]
data_yearly %>%
    group_by(area) %>%
    mutate(
        area_size = impute_mean(area_size),
        median_salary = impute_mean(median_salary)
    )

as.data.frame(data_yearly)
```

The following data manipulations are performed to the yearly data:

* Similarly to monthly data, introduce two additional columns called "year" and "month" to represent the year and month of the data
* Replace the missing values of median salary with its mean values because the percentages missing are low; 
* Replace the missing values of area size with its the associated borough's area size as these area sizes do not change overtime - they have been set in stone since the beginning; and
* Filter for boroughs in London only as that is the target market we are interested in only, this reduces the number of rows to 693.

```{r}
#checking for missing variables again after filtering and manipulating
miss_var_summary(data_yearly)
```
### Joining the two data files into one

The variable we are interested in predicting is the "average house price", which is contained in the monthly data. However, there are more attributes in the yearly data, so the final data table should be the yearly data plus the attributes from the monthly data. The yearly data has 693 observations, made up of data from 33 boroughs over 21 years.

```{r}

#checking that the number of observations are truly unique in the yearly data
#cat("number of unique rows in yearly data = ", nrow(unique(data_yearly[c("year","month","area")])), "\n") #693 rows, so yes, all year/month/area is unique

#use left join to join the monthly data onto the yearly data
#join on year, month, and area
data_final <- left_join(data_yearly, data_monthly, by = c("year", "month", "area"))

#do the same check for unique values in final dataset after join
#cat("number of unique rows in final data = ", nrow(unique(data_final[c("year","month","area")])), "\n")

```
A preview of the final data table is shown below.

```{r}
head(data_final)
```


\newpage
## Exploratory Data Analysis

The dataset now has average house prices for 33 boroughs since 1999 until 2019 (21 years), along with the following 9 attributes:
```{r}
#create matrix with 3 columns
tab <- matrix(c("median salary", "-",
                "mean salary", "-",
                "percentage of recycling houses", "-",
                "population size", "data collected until 2018 only",
                "number of jobs", "(data collected until 2018 only)",
                "number of houses sold", "(data collected until 2018 only)",
                "area size", "(data collected from 2001 only)",
                "number of crimes", "(data collected from 2001 only)",
                "life satisfaction", "(data collected from 2011 only)"), 
              ncol=2, byrow=TRUE)

#define column names and row names of matrix
colnames(tab) <- c("Factor or attribute", "Comments on missing variables")
rownames(tab) <- c("1.", "2.", "3.", "4.", "5.", "6.", "7.", "8.", "9.")

#convert matrix to table 
tab <- as.table(tab)

#view table 
tab

```
The 33 boroughs are shown below. 

```{r}
print(unique((data_final$area)))

```
The graph below shows how average house prices have changed from 1999 to 2019.









Since majority of the data are complete as at 2018, we will only consider analysis on the data from 1999 to 2018, and then separately with life satisfaction from 2011 to 2018. 

Create 2 additional columns. 
Population density = Population size / Area size
Number of houses 

Insights






\newpage
## Factors Contributing to House Prices

### Modelling 1



### Modelling 2


\newpage
## Evaluation of Models





\newpage
## Conclusion




\newpage
## Limitations and Potential Future Work


\newpage
## Appendices

```{r ref.label=knitr::all_labels(), echo=TRUE, eval=FALSE}
```

